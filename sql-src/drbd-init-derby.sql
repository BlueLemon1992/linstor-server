-- drbdmanageNG security subsystem tables
SET ISOLATION SERIALIZABLE;

-- Security configuration
CREATE TABLE SEC_CONFIGURATION
(
    ENTRY_KEY VARCHAR(24) NOT NULL PRIMARY KEY
        CONSTRAINT SEC_CONF_CHKKEY CHECK (UPPER(ENTRY_KEY) = ENTRY_KEY AND LENGTH(ENTRY_KEY) >= 3),
    ENTRY_DSP_KEY VARCHAR(24) NOT NULL,
    ENTRY_VALUE VARCHAR(24) NOT NULL,
        CONSTRAINT SEC_CONF_CHKDSPKEY CHECK (UPPER(ENTRY_DSP_KEY) = ENTRY_KEY)
);

-- Identities / accounts
CREATE TABLE SEC_IDENTITIES
(
    IDENTITY_NAME VARCHAR(24) NOT NULL PRIMARY KEY
        CONSTRAINT SEC_ID_CHKNAME CHECK (UPPER(IDENTITY_NAME) = IDENTITY_NAME AND LENGTH(IDENTITY_NAME) >= 3),
    IDENTITY_DSP_NAME VARCHAR(24) NOT NULL,
    PASS_SALT CHAR(16) FOR BIT DATA,
    PASS_HASH CHAR(64) FOR BIT DATA,
    ID_ENABLED BOOLEAN NOT NULL DEFAULT TRUE,
    ID_LOCKED BOOLEAN NOT NULL DEFAULT TRUE,
        CONSTRAINT SEC_ID_CHKDSPNAME CHECK (UPPER(IDENTITY_DSP_NAME) = IDENTITY_NAME)
);

-- Object types & domains
CREATE TABLE SEC_TYPES
(
    TYPE_NAME VARCHAR(24) NOT NULL PRIMARY KEY
        CONSTRAINT SEC_TYPES_CHKNAME CHECK (UPPER(TYPE_NAME) = TYPE_NAME AND LENGTH(TYPE_NAME) >= 3),
    TYPE_DSP_NAME VARCHAR(24) NOT NULL,
    TYPE_ENABLED BOOLEAN NOT NULL DEFAULT TRUE,
    CONSTRAINT SEC_TYPES_CHKDSPNAME CHECK (UPPER(TYPE_DSP_NAME) = TYPE_NAME)
);

-- Roles
CREATE TABLE SEC_ROLES
(
    ROLE_NAME VARCHAR(24) NOT NULL PRIMARY KEY
        CONSTRAINT SEC_ROLES_CHKNAME CHECK (UPPER(ROLE_NAME) = ROLE_NAME AND LENGTH(ROLE_NAME) >= 3),
    ROLE_DSP_NAME VARCHAR(24) NOT NULL,
    DOMAIN_NAME VARCHAR(24) NOT NULL,
    ROLE_ENABLED BOOLEAN NOT NULL DEFAULT TRUE,
    ROLE_PRIVILEGES BIGINT NOT NULL DEFAULT 0,
    FOREIGN KEY (DOMAIN_NAME) REFERENCES SEC_TYPES(TYPE_NAME),
    CONSTRAINT SEC_ROLES_CHKDSPNAME CHECK (UPPER(ROLE_DSP_NAME) = ROLE_NAME)
);

-- Identities - roles assignments
CREATE TABLE SEC_ID_ROLE_MAP
(
    IDENTITY_NAME VARCHAR(24) NOT NULL,
    ROLE_NAME VARCHAR(24) NOT NULL,
    PRIMARY KEY (IDENTITY_NAME, ROLE_NAME),
    FOREIGN KEY (IDENTITY_NAME) REFERENCES SEC_IDENTITIES(IDENTITY_NAME) ON DELETE CASCADE,
    FOREIGN KEY (ROLE_NAME) REFERENCES SEC_ROLES(ROLE_NAME) ON DELETE CASCADE
);

-- Valid access types
CREATE TABLE SEC_ACCESS_TYPES
(
    ACCESS_TYPE_NAME VARCHAR(24) NOT NULL PRIMARY KEY
        CONSTRAINT SEC_ACCESS_TYPES_CHKNAME CHECK (UPPER(ACCESS_TYPE_NAME) = ACCESS_TYPE_NAME),
    ACCESS_TYPE_VALUE SMALLINT NOT NULL UNIQUE
);

-- Type enforcement rules
CREATE TABLE SEC_TYPE_RULES
(
    DOMAIN_NAME VARCHAR(24) NOT NULL,
    TYPE_NAME VARCHAR(24) NOT NULL,
    ACCESS_TYPE SMALLINT NOT NULL,
    PRIMARY KEY (DOMAIN_NAME, TYPE_NAME),
    FOREIGN KEY (DOMAIN_NAME) REFERENCES SEC_TYPES(TYPE_NAME) ON DELETE CASCADE,
    FOREIGN KEY (TYPE_NAME) REFERENCES SEC_TYPES(TYPE_NAME) ON DELETE CASCADE,
    FOREIGN KEY (ACCESS_TYPE) REFERENCES SEC_ACCESS_TYPES(ACCESS_TYPE_VALUE) ON DELETE RESTRICT
);

-- Identities - default role assignments
CREATE TABLE SEC_DFLT_ROLES
(
    IDENTITY_NAME VARCHAR(24) NOT NULL PRIMARY KEY,
    ROLE_NAME VARCHAR(24) NOT NULL,
    FOREIGN KEY (IDENTITY_NAME, ROLE_NAME) REFERENCES SEC_ID_ROLE_MAP(IDENTITY_NAME, ROLE_NAME)
        ON DELETE CASCADE
);

-- Object proection
CREATE TABLE SEC_OBJECT_PROTECTION
(
    OBJECT_PATH VARCHAR(512) NOT NULL PRIMARY KEY,
    CREATOR_IDENTITY_NAME VARCHAR(24) NOT NULL,
    OWNER_ROLE_NAME VARCHAR(24) NOT NULL,
    SECURITY_TYPE_NAME VARCHAR(24) NOT NULL,
    FOREIGN KEY (CREATOR_IDENTITY_NAME) REFERENCES SEC_IDENTITIES(IDENTITY_NAME) ON DELETE RESTRICT,
    FOREIGN KEY (OWNER_ROLE_NAME) REFERENCES SEC_ROLES(ROLE_NAME) ON DELETE RESTRICT,
    FOREIGN KEY (SECURITY_TYPE_NAME) REFERENCES SEC_TYPES(TYPE_NAME) ON DELETE RESTRICT
);

-- Access control lists
CREATE TABLE SEC_ACL_MAP
(
    OBJECT_PATH VARCHAR(512) NOT NULL,
    ROLE_NAME VARCHAR(24) NOT NULL,
    ACCESS_TYPE SMALLINT NOT NULL,
    PRIMARY KEY (OBJECT_PATH, ROLE_NAME),
    FOREIGN KEY (OBJECT_PATH) REFERENCES SEC_OBJECT_PROTECTION(OBJECT_PATH) ON DELETE CASCADE,
    FOREIGN KEY (ROLE_NAME) REFERENCES SEC_ROLES(ROLE_NAME) ON DELETE RESTRICT,
    FOREIGN KEY (ACCESS_TYPE) REFERENCES SEC_ACCESS_TYPES(ACCESS_TYPE_VALUE) ON DELETE RESTRICT
);

-- Initial data
INSERT INTO SEC_ACCESS_TYPES (ACCESS_TYPE_NAME, ACCESS_TYPE_VALUE)
    VALUES ('CONTROL', 15);
INSERT INTO SEC_ACCESS_TYPES (ACCESS_TYPE_NAME, ACCESS_TYPE_VALUE)
    VALUES ('CHANGE', 7);
INSERT INTO SEC_ACCESS_TYPES (ACCESS_TYPE_NAME, ACCESS_TYPE_VALUE)
    VALUES ('USE', 3);
INSERT INTO SEC_ACCESS_TYPES (ACCESS_TYPE_NAME, ACCESS_TYPE_VALUE)
    VALUES ('VIEW', 1);

INSERT INTO SEC_IDENTITIES (IDENTITY_NAME, IDENTITY_DSP_NAME, ID_ENABLED, ID_LOCKED)
    VALUES('SYSTEM', 'SYSTEM', TRUE, TRUE);
INSERT INTO SEC_IDENTITIES (IDENTITY_NAME, IDENTITY_DSP_NAME, ID_ENABLED, ID_LOCKED)
    VALUES('PUBLIC', 'PUBLIC', TRUE, TRUE);

INSERT INTO SEC_TYPES (TYPE_NAME, TYPE_DSP_NAME, TYPE_ENABLED)
    VALUES ('SYSTEM', 'SYSTEM', TRUE);
INSERT INTO SEC_TYPES (TYPE_NAME, TYPE_DSP_NAME, TYPE_ENABLED)
    VALUES ('PUBLIC', 'PUBLIC', TRUE);

INSERT INTO SEC_ROLES (ROLE_NAME, ROLE_DSP_NAME, DOMAIN_NAME, ROLE_ENABLED, ROLE_PRIVILEGES)
    VALUES('SYSTEM', 'SYSTEM', 'SYSTEM', TRUE, -9223372036854775808);
INSERT INTO SEC_ROLES (ROLE_NAME, ROLE_DSP_NAME, DOMAIN_NAME, ROLE_ENABLED, ROLE_PRIVILEGES)
    VALUES('PUBLIC', 'PUBLIC', 'PUBLIC', TRUE, 0);

INSERT INTO SEC_ID_ROLE_MAP (IDENTITY_NAME, ROLE_NAME)
    VALUES ('SYSTEM', 'SYSTEM');
INSERT INTO SEC_ID_ROLE_MAP (IDENTITY_NAME, ROLE_NAME)
    VALUES ('PUBLIC', 'PUBLIC');

INSERT INTO SEC_DFLT_ROLES (IDENTITY_NAME, ROLE_NAME)
    VALUES ('SYSTEM', 'SYSTEM');
INSERT INTO SEC_DFLT_ROLES (IDENTITY_NAME, ROLE_NAME)
    VALUES ('PUBLIC', 'PUBLIC');

INSERT INTO SEC_CONFIGURATION (ENTRY_KEY, ENTRY_DSP_KEY, ENTRY_VALUE)
    VALUES ('SECURITYLEVEL', 'SecurityLevel', 'MAC');

-- drbdmanageNG Controller configuration
CREATE TABLE CTRL_CONFIGURATION
(
    ENTRY_KEY VARCHAR(512) NOT NULL PRIMARY KEY
        CONSTRAINT CTRL_CONF_CHKKEY CHECK (UPPER(ENTRY_KEY) = ENTRY_KEY AND LENGTH(ENTRY_KEY) >= 1),
    ENTRY_VALUE VARCHAR(512) NOT NULL,
    ENTRY_DSP_KEY VARCHAR(512) NOT NULL,
        CONSTRAINT CTRL_CONF_CHKDSPNAME CHECK (UPPER(ENTRY_DSP_KEY) = ENTRY_KEY)
);

-- drbdmanageNG objects

CREATE TABLE NODES
(
    UUID CHAR(16) FOR BIT DATA NOT NULL,
    NODE_NAME VARCHAR(255) NOT NULL PRIMARY KEY
        CONSTRAINT NODES_CHKNAME CHECK (UPPER(NODE_NAME) = NODE_NAME AND LENGTH(NODE_NAME) >= 2),
    NODE_DSP_NAME VARCHAR(255) NOT NULL,
    NODE_FLAGS BIGINT NOT NULL,
    NODE_TYPE INT NOT NULL,
    CONSTRAINT NODES_CHKDSPNAME CHECK (UPPER(NODE_DSP_NAME) = NODE_NAME)
);

CREATE TABLE NODE_NET_INTERFACES
(
    UUID CHAR(16) FOR BIT DATA NOT NULL,
    NODE_NAME VARCHAR(255) NOT NULL,
    NODE_NET_NAME VARCHAR(255) NOT NULL,
    NODE_NET_DSP_NAME VARCHAR(255) NOT NULL,
    INET_ADDRESS VARCHAR(45) NOT NULL,
    INET_TRANSPORT_TYPE VARCHAR(40) NOT NULL,
    PRIMARY KEY (NODE_NAME, NODE_NET_NAME),
    FOREIGN KEY (NODE_NAME) REFERENCES NODES(NODE_NAME) ON DELETE CASCADE
);

CREATE TABLE RESOURCE_DEFINITIONS
(
    UUID CHAR(16) FOR BIT DATA NOT NULL,
    RESOURCE_NAME VARCHAR(48) NOT NULL PRIMARY KEY
        CONSTRAINT RSC_DFN_CHKNAME CHECK (UPPER(RESOURCE_NAME) = RESOURCE_NAME AND LENGTH(RESOURCE_NAME) >= 3),
    RESOURCE_DSP_NAME VARCHAR(48) NOT NULL,
    RESOURCE_FLAGS BIGINT NOT NULL,
    CONSTRAINT RSC_DFN_CHKDSPNAME CHECK (UPPER(RESOURCE_DSP_NAME) = RESOURCE_NAME)
);

CREATE TABLE RESOURCES
(
    UUID CHAR(16) FOR BIT DATA NOT NULL,
    NODE_NAME VARCHAR(255) NOT NULL,
    RESOURCE_NAME VARCHAR(48) NOT NULL,
    NODE_ID INT NOT NULL,
    RESOURCE_FLAGS BIGINT NOT NULL,
    PRIMARY KEY (NODE_NAME, RESOURCE_NAME),
    FOREIGN KEY (NODE_NAME) REFERENCES NODES(NODE_NAME) ON DELETE CASCADE,
    FOREIGN KEY (RESOURCE_NAME) REFERENCES RESOURCE_DEFINITIONS(RESOURCE_NAME) ON DELETE CASCADE
);

CREATE TABLE STOR_POOL_DEFINITIONS
(
    UUID CHAR(16) FOR BIT DATA NOT NULL,
    POOL_NAME VARCHAR(32) NOT NULL PRIMARY KEY
        CONSTRAINT STOR_POOL_CHKNAME CHECK (UPPER(POOL_NAME) = POOL_NAME AND LENGTH(POOL_NAME) >= 3),
    POOL_DSP_NAME VARCHAR(32) NOT NULL,
    CONSTRAINT STOR_POOL_CHKDSPNAME CHECK (UPPER(POOL_DSP_NAME) = POOL_NAME)
);

CREATE TABLE NODE_STOR_POOL
(
    UUID CHAR(16) FOR BIT DATA NOT NULL UNIQUE,
    NODE_NAME VARCHAR(255) NOT NULL,
    POOL_NAME VARCHAR(32) NOT NULL,
    DRIVER_NAME VARCHAR(256) NOT NULL,
    PRIMARY KEY (NODE_NAME, POOL_NAME),
    FOREIGN KEY (NODE_NAME) REFERENCES NODES(NODE_NAME) ON DELETE CASCADE,
    FOREIGN KEY (POOL_NAME) REFERENCES STOR_POOL_DEFINITIONS(POOL_NAME) ON DELETE CASCADE
);

CREATE TABLE VOLUME_DEFINITIONS
(
    UUID CHAR(16) FOR BIT DATA NOT NULL,
    RESOURCE_NAME VARCHAR(48) NOT NULL,
    VLM_NR INT NOT NULL,
    VLM_SIZE BIGINT NOT NULL,
    VLM_MINOR_NR INT NOT NULL UNIQUE,
    VLM_FLAGS BIGINT NOT NULL,
    PRIMARY KEY (RESOURCE_NAME, VLM_NR),
    FOREIGN KEY (RESOURCE_NAME) REFERENCES RESOURCE_DEFINITIONS(RESOURCE_NAME) ON DELETE CASCADE
);

CREATE TABLE VOLUMES
(
    UUID CHAR(16) FOR BIT DATA NOT NULL,
    NODE_NAME VARCHAR(255) NOT NULL,
    RESOURCE_NAME VARCHAR(48) NOT NULL,
    VLM_NR INT NOT NULL,
    STOR_POOL_NAME VARCHAR(32) NOT NULL,
    BLOCK_DEVICE_PATH VARCHAR(255), -- null == diskless
    META_DISK_PATH VARCHAR(255),  -- null == internal
    VLM_FLAGS BIGINT NOT NULL,
    PRIMARY KEY (NODE_NAME, RESOURCE_NAME, VLM_NR),
    FOREIGN KEY (NODE_NAME, RESOURCE_NAME) REFERENCES RESOURCES(NODE_NAME, RESOURCE_NAME) ON DELETE CASCADE,
    FOREIGN KEY (RESOURCE_NAME, VLM_NR) REFERENCES VOLUME_DEFINITIONS(RESOURCE_NAME, VLM_NR) ON DELETE CASCADE,
    FOREIGN KEY (STOR_POOL_NAME) REFERENCES STOR_POOL_DEFINITIONS(POOL_NAME) ON DELETE CASCADE
);


CREATE TABLE NODE_CONNECTIONS
(
    UUID CHAR(16) FOR BIT DATA NOT NULL,
    NODE_NAME_SRC VARCHAR(255) NOT NULL,
    NODE_NAME_DST VARCHAR(255) NOT NULL,
    PRIMARY KEY (NODE_NAME_SRC, NODE_NAME_DST),
    FOREIGN KEY (NODE_NAME_SRC) REFERENCES NODES(NODE_NAME) ON DELETE CASCADE,
    FOREIGN KEY (NODE_NAME_DST) REFERENCES NODES(NODE_NAME) ON DELETE CASCADE
);

-- old "CONNECTION_DEFINITION"
CREATE TABLE RESOURCE_CONNECTIONS
(
    UUID CHAR(16) FOR BIT DATA NOT NULL,
    NODE_NAME_SRC VARCHAR(255) NOT NULL,
    NODE_NAME_DST VARCHAR(255) NOT NULL,
    RESOURCE_NAME VARCHAR(48) NOT NULL,
    PRIMARY KEY (NODE_NAME_SRC, NODE_NAME_DST, RESOURCE_NAME),
    FOREIGN KEY (NODE_NAME_SRC, RESOURCE_NAME) REFERENCES RESOURCES(NODE_NAME, RESOURCE_NAME) ON DELETE CASCADE,
    FOREIGN KEY (NODE_NAME_DST, RESOURCE_NAME) REFERENCES RESOURCES(NODE_NAME, RESOURCE_NAME) ON DELETE CASCADE
);

CREATE TABLE VOLUME_CONNECTIONS
(
    UUID CHAR(16) FOR BIT DATA NOT NULL,
    NODE_NAME_SRC VARCHAR(255) NOT NULL,
    NODE_NAME_DST VARCHAR(255) NOT NULL,
    RESOURCE_NAME VARCHAR(48) NOT NULL,
    VLM_NR INT NOT NULL,
    PRIMARY KEY (NODE_NAME_SRC, NODE_NAME_DST, RESOURCE_NAME, VLM_NR),
    FOREIGN KEY (NODE_NAME_SRC, RESOURCE_NAME, VLM_NR) REFERENCES VOLUMES(NODE_NAME, RESOURCE_NAME, VLM_NR) ON DELETE CASCADE,
    FOREIGN KEY (NODE_NAME_DST, RESOURCE_NAME, VLM_NR) REFERENCES VOLUMES(NODE_NAME, RESOURCE_NAME, VLM_NR) ON DELETE CASCADE
);

CREATE TABLE PROPS_CONTAINERS
(
    PROPS_INSTANCE VARCHAR(512) NOT NULL
        CONSTRAINT PRP_INST_CHKNAME CHECK(UPPER(PROPS_INSTANCE) = PROPS_INSTANCE AND LENGTH(PROPS_INSTANCE) >= 2),
    PROP_KEY VARCHAR(512) NOT NULL,
    PROP_VALUE VARCHAR(4096) NOT NULL,
    PRIMARY KEY (PROPS_INSTANCE, PROP_KEY)
);

CREATE INDEX IDX_PROPS_CONTAINERS ON PROPS_CONTAINERS (PROPS_INSTANCE ASC);


-- default netCom service
INSERT INTO PROPS_CONTAINERS VALUES ('CTRLCFG', 'netcom/tcp0/bindaddress', 'localhost');
INSERT INTO PROPS_CONTAINERS VALUES ('CTRLCFG', 'netcom/tcp0/port', '9500');
INSERT INTO PROPS_CONTAINERS VALUES ('CTRLCFG', 'netcom/tcp0/type', 'plain');

-- default storage pool definition
INSERT INTO STOR_POOL_DEFINITIONS VALUES (x'f51611c6528f4793a87a866d09e6733a', 'DFLTSTORPOOL', 'DfltStorPool');
-- TODO: change PUBLIC to some new USER
INSERT INTO SEC_OBJECT_PROTECTION (OBJECT_PATH, CREATOR_IDENTITY_NAME, OWNER_ROLE_NAME, SECURITY_TYPE_NAME)
    VALUES('/storpooldefinitions/DFLTSTORPOOL', 'PUBLIC', 'PUBLIC', 'PUBLIC');
INSERT INTO SEC_ACL_MAP (OBJECT_PATH, ROLE_NAME, ACCESS_TYPE)
    VALUES('/storpooldefinitions/DFLTSTORPOOL', 'PUBLIC', 7);

-- Identities load
CREATE VIEW SEC_IDENTITIES_LOAD AS
    SELECT IDENTITY_DSP_NAME, ID_ENABLED
    FROM SEC_IDENTITIES;

-- Roles load
CREATE VIEW SEC_ROLES_LOAD AS
    SELECT ROLE_DSP_NAME, ROLE_ENABLED
    FROM SEC_ROLES;

-- Security types load
CREATE VIEW SEC_TYPES_LOAD AS
    SELECT TYPE_DSP_NAME, TYPE_ENABLED
    FROM SEC_TYPES;

-- Type enforcement rules load
CREATE VIEW SEC_TYPE_RULES_LOAD AS
    SELECT DOMAIN_NAME, TYPE_NAME, SEC_ACCESS_TYPES.ACCESS_TYPE_NAME AS ACCESS_TYPE
    FROM SEC_TYPE_RULES
    LEFT JOIN SEC_ACCESS_TYPES ON SEC_TYPE_RULES.ACCESS_TYPE = SEC_ACCESS_TYPES.ACCESS_TYPE_VALUE
    ORDER BY DOMAIN_NAME, TYPE_NAME ASC;

